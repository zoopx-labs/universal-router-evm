name: CI

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Foundry (robust raw script)
        run: |
          set -euo pipefail
          mkdir -p "$HOME/.foundry/bin"
          echo "Downloading raw foundryup script to $HOME/.foundry/bin/foundryup"
          curl -fsSL "https://raw.githubusercontent.com/foundry-rs/foundry/master/foundryup/foundryup" -o "$HOME/.foundry/bin/foundryup"
          chmod +x "$HOME/.foundry/bin/foundryup"
          ls -la "$HOME/.foundry/bin" || true
          # Invoke foundryup to install toolchain
          "$HOME/.foundry/bin/foundryup" -y
          # Add foundry binaries to PATH for subsequent steps
          echo "$HOME/.foundry/bin" >> $GITHUB_PATH

      - name: Install npm deps if present
        run: |
          if [ -f package.json ]; then npm ci; fi

      - name: Run Forge tests
        run: forge test --via-ir -v

      - name: Run Slither (Docker)
        run: |
          mkdir -p results
          docker run --rm -v ${{ github.workspace }}:/src -w /src ghcr.io/crytic/slither:latest \
            slither --solc-remaps "@openzeppelin/=node_modules/@openzeppelin/" --json results/slither.json || true

      - name: Upload Slither results
        uses: actions/upload-artifact@v4
        with:
          name: slither-results
          path: results/slither.json
